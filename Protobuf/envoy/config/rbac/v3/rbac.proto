syntax = "proto3";

package envoy.config.rbac.v3;

import "envoy/config/core/v3/address.proto";
import "envoy/config/core/v3/extension.proto";
import "envoy/config/route/v3/route_components.proto";
import "envoy/type/matcher/v3/metadata.proto";
import "envoy/type/matcher/v3/path.proto";
import "envoy/type/matcher/v3/string.proto";
import "envoy/type/v3/range.proto";
import "google/api/expr/v1alpha1/checked.proto";
import "google/api/expr/v1alpha1/syntax.proto";
import "envoy/annotations/deprecation.proto";
import "udpa/annotations/migrate.proto";
import "udpa/annotations/status.proto";
import "udpa/annotations/versioning.proto";
import "validate/validate.proto";

message RBAC {
  .envoy.config.rbac.v3.RBAC.Action action = 1;
  map<string, .envoy.config.rbac.v3.Policy> policies = 2;

  enum Action {
    ALLOW = 0;
    DENY = 1;
    LOG = 2;
  }
}

message Policy {
  repeated .envoy.config.rbac.v3.Permission permissions = 1;
  repeated .envoy.config.rbac.v3.Principal principals = 2;
  .google.api.expr.v1alpha1.Expr condition = 3;
  .google.api.expr.v1alpha1.CheckedExpr checked_condition = 4;
}

message Permission {
  oneof rule {
    .envoy.config.rbac.v3.Permission.Set and_rules = 1;
    .envoy.config.rbac.v3.Permission.Set or_rules = 2;
    bool any = 3;
    .envoy.config.route.v3.HeaderMatcher header = 4;
    .envoy.type.matcher.v3.PathMatcher url_path = 10;
    .envoy.config.core.v3.CidrRange destination_ip = 5;
    uint32 destination_port = 6;
    .envoy.type.v3.Int32Range destination_port_range = 11;
    .envoy.type.matcher.v3.MetadataMatcher metadata = 7;
    .envoy.config.rbac.v3.Permission not_rule = 8;
    .envoy.type.matcher.v3.StringMatcher requested_server_name = 9;
    .envoy.config.core.v3.TypedExtensionConfig matcher = 12;
  }

  message Set {
    repeated .envoy.config.rbac.v3.Permission rules = 1;
  }
}

message Principal {
  oneof identifier {
    .envoy.config.rbac.v3.Principal.Set and_ids = 1;
    .envoy.config.rbac.v3.Principal.Set or_ids = 2;
    bool any = 3;
    .envoy.config.rbac.v3.Principal.Authenticated authenticated = 4;
    .envoy.config.core.v3.CidrRange source_ip = 5 [ deprecated = true ];
    .envoy.config.core.v3.CidrRange direct_remote_ip = 10;
    .envoy.config.core.v3.CidrRange remote_ip = 11;
    .envoy.config.route.v3.HeaderMatcher header = 6;
    .envoy.type.matcher.v3.PathMatcher url_path = 9;
    .envoy.type.matcher.v3.MetadataMatcher metadata = 7;
    .envoy.config.rbac.v3.Principal not_id = 8;
  }

  message Set {
    repeated .envoy.config.rbac.v3.Principal ids = 1;
  }
  message Authenticated {
    .envoy.type.matcher.v3.StringMatcher principal_name = 2;
  }
}

message Action {
  string name = 1;
  .envoy.config.rbac.v3.RBAC.Action action = 2;
}

